
Introduction
============

This repository (H01LocalConnectome) contains various structural/functional interrogations (and visualisations) of the H01 Release human connectome dataset, and software used in their derivation. The H01 "Local Connectome" is taken as the connectivity data between those neurons (neuron_id) which have cell soma/centroids that reside within the H01 Release dataset. The local connectome is analysed along with its immediate incoming and outgoing connections.

Acknowledgements
================

Source datasets are from the H01 Release of the Petascale Reconstruction of the Human Cortex, as provided by The Lichtman laboratory at Harvard University and the Connectomics at Google team (https://h01-release.storage.googleapis.com/landing.html):

*Shapson-Coe, A., Januszewski, M., Berger, D.R., Pope, A., Wu, Y., Blakely, T., Schalek, R.L., Li, P., Wang, S., Maitin-Shepard, J. et al. (2021). A connectomic study of a petascale fragment of human cerebral cortex. bioRxiv. (https://www.biorxiv.org/content/10.1101/2021.05.29.446289v2)*

**SVG plots of excitatory/inhibitory connections in local connectome** (connection types derived from EM images, directionality not encoded):
- https://storage.googleapis.com/h01-release/data/20210601/svg/connections_E.svg
- https://storage.googleapis.com/h01-release/data/20210601/svg/connections_I.svg

**C3 Synaptic connections database** - export of synaptic connections in Apache Avro/Json format (connection types derived from EM images, pre-post synaptic directionality encoded):
- gs://h01-release/data/20210601/c3/synapses/exported/json (https://h01-release.storage.googleapis.com/data.html)

**Local connectome dataset** as provided by Dr Yuelong Wu of the The Lichtman laboratory (includes cell centroids and cell types, pre-post synaptic directionality encoded):
- in_body_cell_connection.csv

Additional H01 Release datasets or updates thereto are expected. As of the bioRxiv v2 release of the H01 paper, the synapse predictions are still being refined so may be subject to future changes. The cell types, synapses types etc. were all generated by deep learning models trained by The Lichtman laboratory and their collaborators at Google, and they internally used Google BigQuery to share the data. Because the BigQuery tables are not discoverable by outside groups, they exported the synapse table to Avro format when releasing the data. There are other database (e.g. cell type table including coordinates, compartment type table, some of which are huge sized tables) which have not yet been released.

License
=======

All BAI H01LocalConnectome repository software is licensed with the MIT License unless otherwise specified.

Content
=======

H01 indexed CSV database software
---------------------------------

*H01indexedCSVdatabase*

### Source code description

H01indexedCSVdatabase.cpp/.hpp:

 * Description: H01 indexed CSV database
 * Requirements: BAI SHARED C++ library, Eigen 3 C++ library
 * Compilation: ./compileH01indexedCSVdatabase.sh
 * Usage: ./H01indexedCSVdatabase.exe

H01indexedCSVdatabaseCreate.cpp/.hpp (execution mode 1: INDEXED_CSV_DATABASE_CREATE):

 * Description: H01 indexed CSV database create - convert C3 Synaptic connections Avro Json To indexed CSV database (indexed by pre/postsynaptic neuron ID)
 * Input: C3 Synaptic connections database (gs://h01-release/data/20210601/c3/synapses/exported/json)
 * Output Format: ssddata/indexed/123/csvPreSynapticNeuronID123456.csv - presynapticSiteNeuronID, postsynapticSiteNeuronID, presynapticSiteType, postsynapticSiteType, presynapticSiteClassLabel, postsynapticSiteClassLabel, presynapticSiteBaseNeuronID, postsynapticSiteBaseNeuronID, synapseLocationXcoordinates, synapseLocationYcoordinates, synapseLocationZcoordinates, synapseType

H01indexedCSVdatabaseQuery.cpp/.hpp (execution mode 2: INDEXED_CSV_DATABASE_QUERY):

 * Description: H01 indexed CSV database query -
     * INDEXED_CSV_DATABASE_QUERY_EXTRACT_INCOMING_OUTGOING_CONNECTIONS: mode 1 (lookup indexed CSV database by neuron ID, and find incoming/outgoing target connections, and write them to file)
     * INDEXED_CSV_DATABASE_QUERY_PERFORM_INCOMING_AXON_MAPPING: mode 2 (lookup indexed CSV database by neuron ID, find incoming target connections, and generate visualisation)
     * INDEXED_CSV_DATABASE_QUERY_GENERATE_LOCAL_CONNECTOME_CONNECTIONS_DATASET: mode 3 (automatically generate localConnectomeConnections-typesFromPresynapticNeurons.csv/localConnectomeConnections-typesFromEMimages.csv from localConnectomeNeurons.csv and indexed CSV database)
     * INDEXED_CSV_DATABASE_QUERY_COUNT_PROPORTION_LOCAL_VS_NONLOCAL_CONNECTIONS: mode 4 (lookup indexed CSV database by neuron ID, count/infer proportion of incoming/outgoing excitatory/inhibitory target connections to local vs distal neurons)
 * Input: 
     * INDEXED_CSV_DATABASE_QUERY_OUTPUT_CONNECTIONS: localConnectomeNeurons.csv (or localConnectomeNeuronIDlistDistinct.csv)
     * INDEXED_CSV_DATABASE_QUERY_PERFORM_INCOMING_AXON_MAPPING: localConnectomeNeurons.csv (or localConnectomeNeuronIDlistDistinct.csv)
     * INDEXED_CSV_DATABASE_QUERY_GENERATE_LOCAL_CONNECTOME_CONNECTIONS_DATASET: localConnectomeNeurons.csv
     * INDEXED_CSV_DATABASE_QUERY_COUNT_PROPORTION_LOCAL_VS_NONLOCAL_CONNECTIONS: localConnectomeNeurons.csv (or localConnectomeNeuronIDlistDistinct.csv)
 * Output Format (csv):
     * INDEXED_CSV_DATABASE_QUERY_OUTPUT_CONNECTIONS: localConnectomeNeuronIDlistConnectionsPresynaptic.csv/localConnectomeNeuronIDlistConnectionsPostsynaptic.csv - connectionNeuronID1, connectionType1 [, locationObjectContentsXcoordinatesContent1, locationObjectContentsYcoordinatesContent1, locationObjectContentsZcoordinatesContent1], connectionNeuronID2, connectionType2 [, locationObjectContentsXcoordinatesContent2, locationObjectContentsYcoordinatesContent2, locationObjectContentsZcoordinatesContent2], etc 
     * INDEXED_CSV_DATABASE_QUERY_PERFORM_INCOMING_AXON_MAPPING:
        * INDEXED_CSV_DATABASE_QUERY_PERFORM_INCOMING_AXON_MAPPING_3D_LINEAR_REGRESSION:
            * INDEXED_CSV_DATABASE_QUERY_OUTPUT_INCOMING_AXON_MAPPING_LDR: localConnectomeIncomingAxonMapping.ldr - LDR_TYPE_LINE ldrawColor plot3DpointStart.x plot3DpointStart.y plot3DpointStart.z plot3DpointEnd.x plot3DpointEnd.y plot3DpointEnd.z
             * INDEXED_CSV_DATABASE_QUERY_OUTPUT_INCOMING_AXON_MAPPING_CSV: localConnectomeIncomingAxonMapping.csv - polyFit.connectionNeuronID, polyFit.estSynapseType, polyFit.origin.x, polyFit.origin.y, polyFit.origin.z, polyFit.axis.x, polyFit.axis.y, polyFit.axis.z
        * INDEXED_CSV_DATABASE_QUERY_PERFORM_INCOMING_AXON_MAPPING_2D_POLY_REGRESSION:
             * INDEXED_CSV_DATABASE_QUERY_OUTPUT_INCOMING_AXON_MAPPING_CSV: localConnectomeIncomingAxonMapping.csv - polyFit.connectionNeuronID, polyFit.estSynapseType, polyFit.a, polyFit.b, polyFit.c
     * INDEXED_CSV_DATABASE_QUERY_GENERATE_LOCAL_CONNECTOME_CONNECTIONS_DATASET: localConnectomeConnections.csv - pre_id, pre_x, pre_y, pre_z, pre_type, post_id, post_x, post_y, post_z, post_type, post_class_label, syn_num, excitation_type
     * INDEXED_CSV_DATABASE_QUERY_COUNT_PROPORTION_LOCAL_VS_NONLOCAL_CONNECTIONS: N/A

H01indexedCSVdatabaseVisualiseLocalConnectome.cpp/.hpp (execution mode 3: INDEXED_CSV_DATABASE_VISUALISE_LOCAL_CONNECTOME):

 * Description: H01 indexed CSV database visualise local connectome
 * Input: localConnectomeNeurons.csv / localConnectomeConnectionsX.csv
 * Output Format: SVG (2D) / LDR (3D)

### Command line interface
```
Usage:  H01indexedCSVdatabase.exe [options]

where options are any of the following (see documentation)

-mode [int]                             : execution mode (1: create, 2: query, 3: visualise (def: 2) [compulsory]
-query [int]                            : query mode (1: extract, 2: map, 3: generate, 4: count (def: 4)

-avro_json_database_folder [string]     : H01 C3 Synaptic connections database json folder (def: /media/user/large/h01data/data/exported/json)
-indexed_csv_database_folder [string]   : H01 indexed csv database folder (def: /media/user/ssddata/indexed)
-local_connectome_folder_base [string]  : H01 local connectome base folder containing "datasets" and "visualisations" (def: ../)


execution mode 1 - INDEXED_CSV_DATABASE_CREATE - converts Avro Json C3 Synaptic connections database to indexed CSV database, indexed by pre/postsynaptic neuron ID
execution mode 2 - INDEXED_CSV_DATABASE_QUERY - queries indexed CSV database, based on local connectome neuron id list
execution mode 3 - INDEXED_CSV_DATABASE_VISUALISE_LOCAL_CONNECTOME - visualises datasets

query mode 1 - INDEXED_CSV_DATABASE_QUERY_EXTRACT_INCOMING_OUTGOING_CONNECTIONS - lookup indexed CSV database by neuron ID, and find incoming/outgoing target connections, and write them to file
query mode 2 - INDEXED_CSV_DATABASE_QUERY_PERFORM_INCOMING_AXON_MAPPING - lookup indexed CSV database by neuron ID, find incoming target connections, and generate visualisation
query mode 3 - INDEXED_CSV_DATABASE_QUERY_GENERATE_LOCAL_CONNECTOME_CONNECTIONS_DATASET - automatically generate localConnectomeConnections-typesFromPresynapticNeurons.csv/localConnectomeConnections-typesFromEMimages.csv from localConnectomeNeurons.csv and indexed CSV database
query mode 4 - INDEXED_CSV_DATABASE_QUERY_COUNT_PROPORTION_LOCAL_VS_NONLOCAL_CONNECTIONS - lookup indexed CSV database by neuron ID, count/infer proportion of incoming/outgoing excitatory/inhibitory target connections to local vs distal neurons

```

### Usage examples
```
./compileH01indexedCSVdatabase.sh
./H01indexedCSVdatabase.exe -mode 1 -avro_json_database_folder "/media/user/large/h01data/data/exported/json" -indexed_csv_database_folder "/media/user/ssddata/indexed"
./H01indexedCSVdatabase.exe -mode 2 -query 1 -indexed_csv_database_folder "/media/user/ssddata/indexed"
./H01indexedCSVdatabase.exe -mode 2 -query 2 -indexed_csv_database_folder "/media/user/ssddata/indexed"
./H01indexedCSVdatabase.exe -mode 2 -query 3 -indexed_csv_database_folder "/media/user/ssddata/indexed"
./H01indexedCSVdatabase.exe -mode 2 -query 4 -indexed_csv_database_folder "/media/user/ssddata/indexed"
./H01indexedCSVdatabase.exe -mode 3
```

 
H01 local connectome visualisations
-----------------------------------

*visualisations/connectionTypesFromEMimages*\
*visualisations/connectionTypesFromPresynapticNeurons*

LDView can be used to view 3D LDR visualisations (https://tcobbs.github.io/ldview/Downloads.html). \
A web browser/Inkscape/etc can be used to view 2D SVG visualisations.

Current local connectome visualisations for connectionTypesDerivedFromEMimages/connectionTypesDerivedFromPresynapticNeurons include:

*2D (SVG)*
- connections_IE1.svg - connections coloured by excitatory/inhibitory type and pre/post synaptic direction; neurons coloured by cell type.
- connections_IE_flow1.svg - connections coloured by excitatory/inhibitory type and flow direction (through the cortical layers); neurons coloured by cell type.
- connections_IE_flow2.svg - connections coloured by excitatory/inhibitory type, pre/post synaptic direction, and flow direction (through the cortical layers) [unique hue for connection source and target]; neurons coloured by cell type.
- connections_IE_flow3.svg - connections coloured by excitatory/inhibitory type, pre/post synaptic direction, and flow direction (through the cortical layers) [unique hue for connection target only]; neurons coloured by cell type.
- connections_IE_layered1.svg (connections_IE_layered1_Lx.svg) - neurons/connections coloured by layer (excitatory/inhibitory connection types indicated by saturation).
- connections_IE_layered2.svg (connections_IE_layered2_Lx.svg) - connections coloured by excitatory/inhibitory type and pre/post synaptic direction; neurons coloured by cell type.
- connections_IE_layered_flow1.svg (connections_IE_layered_flow1_Lx.svg) - connections coloured by excitatory/inhibitory type and flow direction (through the cortical layers); neurons coloured by cell type.
- connections_IE_layered_flow2.svg (connections_IE_layered_flow2_Lx.svg) - connections coloured by excitatory/inhibitory type, pre/post synaptic direction, and flow direction (through the cortical layers) [unique hue for connection source and target]; neurons coloured by cell type.

2D SVG colour sets can be changed by modifying the visualisations/templates/connections_IE_part2-\*.svg file <"linearGradient"> tags.\
2D SVG colour sets can be added/removed by modifying H01indexedCSVdatabase.hpp: LOCAL_CONNECTOME_VISUALISATION_SVG_FILENAME_\*_NUMBER_COLOURSETS and adding/removing visualisations/templates/connections_IE_part2-\*X.svg.

*3D (SVG)*
- connections_IE1.ldr - connections coloured by excitatory/inhibitory type; neurons coloured by cell type.
- connections_IE_flow1.ldr - connections coloured by excitatory/inhibitory type and flow direction (through the cortical layers); neurons coloured by cell type.
- connections_IE_layered1.ldr (connections_IE_layered1_Lx.ldr) - neurons/connections coloured by layer (excitatory/inhibitory connection types indicated by saturation).
- connections_IE_layered2.ldr (connections_IE_layered2_Lx.ldr) - connections coloured by excitatory/inhibitory type; neurons coloured by cell type.
- connections_IE_layered_flow1.ldr (connections_IE_layered_flow1_Lx.ldr) - connections coloured by excitatory/inhibitory type and flow direction (through the cortical layers); neurons coloured by cell type.

3D LDR colour sets can be changed by modifying H01indexedCSVdatabase.hpp: LOCAL_CONNECTOME_VISUALISATION_CONNECTIONS_COLOUR_\*.\
3D LDR colour sets can be added/removed by modifying H01indexedCSVdatabase.hpp: LOCAL_CONNECTOME_VISUALISATION_LDR_FILENAME_\*_NUMBER_COLOURSETS and upgrading the source code (advanced).

